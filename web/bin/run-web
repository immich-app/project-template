#!/usr/bin/env sh

cd /usr/src/app || exit

pnpm --filter @server/sdk build

COUNT=0
UPSTREAM="${SERVER_URL:-http://server:2283/}"
UPSTREAM="${UPSTREAM%/}"
until curl --silent --fail "${UPSTREAM}/api/server/ping" > /dev/null 2>&1; do
    if [ $((COUNT % 10)) -eq 0 ]; then
      echo "Waiting for $UPSTREAM to start..."
    fi
    COUNT=$((COUNT + 1))
    sleep 1
done
echo "Connected to $UPSTREAM, starting immichtemplate Web..."
pnpm --filter web exec vite dev --host 0.0.0.0 --port 3000
